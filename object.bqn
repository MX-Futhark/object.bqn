minBuckets â† 8
maxBuckets â† 2 â‹† 16
minLoadFactor â† 0.25
maxLoadFactor â† 0.9

## Creates an object following prototype-based OO conventions.
## Param ğ•©: âŸ¨stringâ€¿any, ...âŸ© | @ - Optional list of initial properties as key/value pairs.
## Returns: object
Object â‡ {ğ•Š:
  self â† {
    buckets â† minBuckets â¥Š âŸ¨âŸ¨âŸ©âŸ©

    ## Prototype of the object.
    ## Type: object | @
    prototype â‡ @

    ## Initializer called alongside New.
    ## Type: (self ğ•Š any) => void
    initializer â‡ {{self ğ•Š arg: @}}

    ## Prototype of objects produced by New.
    ## Type: object | @
    instancePrototype â‡ @

    ## Tells if the given property can be found in the prototype chain of the object.
    ## Param ğ•©: string
    ## Returns: boolean
    Has â‡ {ğ•Š key:
      item â† RawGetOwn key
      {
        ShouldUsePrototype item ? prototype.Has key ;
        item â‰¢ âŸ¨âŸ©
      }
    }

    ## Tells if the given property is known by the object, not taking its prototype chain into account.
    ## Param ğ•©: string
    ## Returns: boolean
    HasOwn â‡ {ğ•Š key:
      âŸ¨âŸ© â‰¢ RawGetOwn key
    }

    ## Retrieves the value of a property by its name in the prototype chain.
    ## Param ğ•©: string
    ## Returns: any
    ## Throws: "Unknown key" - The property could not be found in the prototype chain of the object.
    Get â‡ {ğ•Š key:
      item â† RawGetOwn key
      {
        ShouldUsePrototype item ? prototype.Get key ;
        "Unknown key" ! item â‰¢ âŸ¨âŸ©
        1âŠ‘âŠ‘item
      }
    }

    ## Sets or changes a property of the object. Shadows the prototype property of the same name if it exists.
    ## Param ğ•©: stringâ€¿any - The name of the property as the first element, the associated value as the second one.
    ## Returns: self
    Set â‡ {ğ•Š keyâ€¿value:
      HasOwnâ—¶âŠ¢â€¿RawDelete key
      RawSet keyâ€¿value
      Resize@
      self
    }

    ## Removes a property by its name.
    ## Param ğ•©: string
    ## Returns: self
    ## Throws: "Unknown own key" - The property does not exist, not taking the prototype chain into account.
    Delete â‡ {ğ•Š key:
      item â† RawGetOwn key
      "Unknown own key" ! item â‰¢ âŸ¨âŸ©
      RawDelete key
      Resize@
      self
    }

    ## All key/value pairs in the object in no particular order, not taking its prototype chain into account.
    ## Param ğ•©: @
    ## Returns: âŸ¨stringâ€¿any, ...âŸ©
    Entries â‡ {ğ•Š:
      {ğ•¨ âˆ¾ ğ•©}Â´buckets
    }

    ## All property names in the object in no particular order, not taking its prototype chain into account.
    ## Param ğ•©: @
    ## Returns: âŸ¨string, ...âŸ©
    Keys â‡ {ğ•Š:
      {âŠ‘ğ•©}Â¨Entries@
    }

    ## Sends a message to the object, which will be handled by a method,
    ## i.e. a function property of the form (self ğ•Š any) => any.
    ## `arg o.SendâŸœ"method"` and `o.SendâŸœ"method" arg` are sugar for `oâŠ¸(o.Get "method") arg`.
    ## Param ğ•¨: arg - Left argument of the method.
    ## Param ğ•©: string - Name of the method.
    ## Returns: (ğ•Š any) => any
    Send â‡ {arg ğ•Š key:
      selfâŠ¸(Get key) arg
    }

    ## Creates an instance of the current object type.
    ## Sets the current `instancePrototype` as its `prototype` and calls the current `initializer` with the result.
    ## Param ğ•©: any - Argument to forward to the left argument of the initializer.
    ## Returns: object - The newly created instance.
    New â‡ {ğ•Š arg:
      instance â† Object@
      instance.SetPrototype instancePrototype
      instanceâŠ¸Initializer arg
      instance
    }

    ## Tells if the object is an instance of the given object type.
    ## Param ğ•©: object
    ## Returns: boolean
    InstanceOf â‡ {ğ•Š type:
      (prototype â‰¡ type.instancePrototype) âˆ¨ {
        prototype â‰¡ @ ? 0 ;
        prototype.InstanceOf type
      }
    }

    ## Changes the prototype of the object.
    ## Param ğ•©: object
    ## Returns: self
    SetPrototype â‡ {ğ•Š newPrototype:
      prototype â†© newPrototype
      self
    }

    ## Changes the initializer.
    ## Param ğ•©: (self ğ•Š any) => void
    ## Returns: self
    SetInitializer â‡ {ğ•Š newInitializer:
      initializer â†© newInitializer
      self
    }

    ## Changes the prototype of objects produced by New.
    ## Param ğ•©: object
    ## Returns: self
    SetInstancePrototype â‡ {ğ•Š newInstancePrototype:
      instancePrototype â†© newInstancePrototype
      self
    }

    RawGetOwn â† {ğ•Š key:
      key â‰¡_filterBucket buckets âŠ‘Ëœ BucketIndex key
    }

    RawSet â† {ğ•Š keyâ€¿value:
      ind â† BucketIndex key
      buckets (âŸ¨keyâ€¿valueâŸ© âˆ¾Ëœ ind âŠ‘ buckets)âŒ¾(indâŠ¸âŠ‘)â†©
    }

    RawDelete â† {ğ•Š key:
      buckets {key â‰¢_filterBucket ğ•©}Â¨â†©
    }

    Resize â† {ğ•Š:
      entriesBackup â† Entries@
      loadFactor â† entriesBackup Ã·â—‹â‰  buckets
      lengthFactor â† {
        (minBuckets < â‰ buckets) âˆ§ loadFactor â‰¤ minLoadFactor ? 0.5 ;
        (maxBuckets > â‰ buckets) âˆ§ loadFactor â‰¥ maxLoadFactor ? 2 ; 1
      }
      lengthFactor â‰  1 ?
      buckets â†© lengthFactor Ã— (â‰ buckets) â¥Š âŸ¨âŸ¨âŸ©âŸ©
      RawSetÂ¨entriesBackup ; @
    }

    ShouldUsePrototype â† {ğ•Š item:
      (item â‰¡ âŸ¨âŸ©) âˆ§ prototype â‰¢ @
    }

    BucketIndex â† {ğ•Š key:
      (â‰ buckets) | Djb2 key
    }

    _filterBucket â† {key compare _ğ•£ bucket:
      {key Compare âŠ‘ğ•©}Â¨âŠ¸/bucket
    }
  }

  self.SetÂ¨(ğ•© â‰¡ @) âŠ‘ âŸ¨ğ•©, âŸ¨âŸ©âŸ©

  self
}

Djb2 â† { ğ•Š str:
  "Cannot hash non-string value" ! str =â—‹â€¢Type ""

  # http://www.cse.yorku.ca/~oz/hash.html
  5381 {maxBuckets | ğ•¨ + ğ•© Ã— 33}Â´âŒ½{ğ•© - @}Â¨str
}
