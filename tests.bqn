âŸ¨ObjectâŸ© â† â€¢Import "object.bqn"

{ğ•Š testNameâ€¿testCase:
  â€¢Out testName
  TestCase@
  â€¢Out "  OK"
}Â¨âŸ¨
  "create object"â€¿{ğ•Š:
    ! {Object@ â‹„ 1}
    ! {Object âŸ¨"foo"â€¿0, "bar"â€¿1âŸ© â‹„ 1}
  }

  "set prototype"â€¿{ğ•Š:
    o â† Object@
    proto â† Object âŸ¨"foo"â€¿0, "bar"â€¿1âŸ©

    result â† o.SetPrototype proto

    ! o.prototype â‰¡ proto
    ! result â‰¡ o
  }

  "set instance prototype"â€¿{ğ•Š:
    o â† Object@
    instanceProto â† Object âŸ¨"foo"â€¿0, "bar"â€¿1âŸ©

    result â† o.SetInstancePrototype instanceProto

    ! o.instancePrototype â‰¡ instanceProto
    ! result â‰¡ o
  }

  "set initializer"â€¿{ğ•Š:
    o â† Object âŸ¨"foo"â€¿0, "bar"â€¿1âŸ©
    called â† @

    result â† o.SetInitializer {{self ğ•Š arg:
      called â†© selfâ€¿arg
    }}
    oâŠ¸o.initializer "a"

    ! called â‰¡ oâ€¿"a"
    ! result â‰¡ o
  }

  "entries"â€¿{ğ•Š:
    entries â† ((Object âŸ¨"foo"â€¿0, "bar"â€¿1âŸ©).SetPrototype Object âŸ¨"baz"â€¿2âŸ©).Entries@

    ! (â‰ entries) = 2
    ! (â‰ entries) > âŠ‘(entries âŠ âŸ¨"foo"â€¿0âŸ©)
    ! (â‰ entries) > âŠ‘(entries âŠ âŸ¨"bar"â€¿1âŸ©)
  }

  "keys"â€¿{ğ•Š:
    keys â† ((Object âŸ¨"foo"â€¿0, "bar"â€¿1âŸ©).SetPrototype Object âŸ¨"baz"â€¿2âŸ©).Keys@

    ! (â‰ keys) = 2
    ! (â‰ keys) > âŠ‘(keys âŠ âŸ¨"foo"âŸ©)
    ! (â‰ keys) > âŠ‘(keys âŠ âŸ¨"bar"âŸ©)
  }

  "has own"â€¿{ğ•Š:
    ! Â¬(Object@).HasOwn "foo"
    ! (Object âŸ¨"foo"â€¿0âŸ©).HasOwn "foo"
    ! Â¬((Object@).SetPrototype Object âŸ¨"foo"â€¿0âŸ©).HasOwn "foo"
  }

  "has"â€¿{ğ•Š:
    ! Â¬(Object@).Has "foo"
    ! (Object âŸ¨"foo"â€¿0âŸ©).Has "foo"
    ! ((Object@).SetPrototype Object âŸ¨"foo"â€¿0âŸ©).Has "foo"
  }

  "get"â€¿{ğ•Š:
    ! {ğ•Š: (Object@).Get "foo" â‹„ 0}âŠ{ğ•Š: 1}@
    ! 0 = (Object âŸ¨"foo"â€¿0âŸ©).Get "foo"
    ! 0 = ((Object@).SetPrototype Object âŸ¨"foo"â€¿0âŸ©).Get "foo"
    ! 0 = ((Object âŸ¨"foo"â€¿0âŸ©).SetPrototype Object âŸ¨"foo"â€¿1âŸ©).Get "foo"
  }

  "set"â€¿{ğ•Š:
    proto â† Object âŸ¨"a"â€¿Â¯1âŸ©
    o â† (Object@).SetPrototype proto

    # Set more than 8 properties to trigger a resize
    o.SetÂ¨âŸ¨"a"â€¿0, "b"â€¿1, "c"â€¿2, "d"â€¿3, "e"â€¿4, "f"â€¿5, "g"â€¿6, "h"â€¿7, "i"â€¿8âŸ©
    o.Set "i"â€¿88

    ! 0â€¿1â€¿2â€¿3â€¿4â€¿5â€¿6â€¿7â€¿88 â‰¡ o.GetÂ¨"a"â€¿"b"â€¿"c"â€¿"d"â€¿"e"â€¿"f"â€¿"g"â€¿"h"â€¿"i"
    ! Â¯1 = proto.Get "a"
    ! {ğ•Š: o.Set 0â€¿"bad key" â‹„ 0}âŠ{ğ•Š: 1}@
  }

  "delete"â€¿{ğ•Š:
    proto â† Object âŸ¨"foo"â€¿0âŸ©
    o â† (Object âŸ¨"foo"â€¿1âŸ©).SetPrototype proto

    o.Delete "foo"

    ! Â¬o.HasOwn "foo"
    ! proto.HasOwn "foo"
    ! {ğ•Š: o.Delete "foo" â‹„ 0}âŠ{ğ•Š: 1}@
  }

  "send"â€¿{ğ•Š:
    called â† âŸ¨âŸ©
    MakeMethodEntry â† {ğ•Š name:
      nameâ€¿{self ğ•Š arg:
        called â†© called âˆ¾ âŸ¨nameâ€¿selfâ€¿argâŸ©
      }
    }
    proto â† Object âŸ¨MakeMethodEntry "bar"âŸ©
    o â† (Object âŸ¨MakeMethodEntry "foo"âŸ©).SetPrototype proto

    o.SendâŸœ"foo" 0
    o.SendâŸœ"bar" 1

    ! called â‰¡ âŸ¨"foo"â€¿oâ€¿0, "bar"â€¿oâ€¿1âŸ©
  }

  "new"â€¿{ğ•Š:
    called â† @
    class â† Object@
    class.SetInstancePrototype âŸ¨"foo"â€¿0âŸ©
    class.SetInitializer {{self ğ•Š name:
      called â†© selfâ€¿name
    }}

    result â† class.New "bar"

    ! called â‰¡ resultâ€¿"bar"
    ! result.prototype â‰¡ class.instancePrototype
  }

  "instance of"â€¿{ğ•Š:
    GetClass â† {ğ•Š:
      class â† Object@
      class.SetInstancePrototype Object@
    }
    parent â† GetClass@
    child â† GetClass@
    child.instancePrototype.SetPrototype parent.instancePrototype
    unrelated â† GetClass@
    result â† child.New@

    ! result.InstanceOf child
    ! result.InstanceOf parent
    ! Â¬result.InstanceOf unrelated
  }
âŸ©
â€¢Out "All tests passed"
